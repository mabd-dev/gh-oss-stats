name: Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
      - dev

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        go-version: ['1.23', '1.24', '1.25']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Display coverage
        run: go tool cover -func=coverage.out

  build:
    name: Build Binary
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Build CLI
        run: |
          echo "Building gh-oss-stats ..."
          mkdir -p dist
          GOOS=linux  GOARCH=amd64  go build -o dist/gh-oss-stats-linux-amd64   ./cmd/gh-oss-stats/main.go
          GOOS=linux  GOARCH=arm64  go build -o dist/gh-oss-stats-linux-arm64   ./cmd/gh-oss-stats/main.go
          GOOS=darwin GOARCH=arm64  go build -o dist/gh-oss-stats-darwin-arm64 ./cmd/gh-oss-stats/main.go

      - name: Verify binaries
        run: |
          ./dist/gh-oss-stats-linux-amd64 --version || ./dist/gh-oss-stats-linux-amd64 --help
          
          # Verify binary formats
          file dist/gh-oss-stats-linux-amd64   # Should show: ELF 64-bit LSB executable, x86-64
          file dist/gh-oss-stats-linux-arm64   # Should show: ELF 64-bit LSB executable, ARM aarch64
          file dist/gh-oss-stats-darwin-arm64  # Should show: Mach-O 64-bit arm64 executable
