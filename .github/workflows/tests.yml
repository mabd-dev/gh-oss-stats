name: Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
      - dev

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        go-version: ['1.23', '1.24', '1.25']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Display coverage
        run: go tool cover -func=coverage.out

  build:
    name: Build Binary
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Build CLI
        run: |
          echo "Building gh-oss-stats ..."
          mkdir -p dist
          GOOS=linux  GOARCH=amd64  go build -o dist/gh-oss-stats-linux-amd64   ./cmd/gh-oss-stats/main.go
          GOOS=linux  GOARCH=arm64  go build -o dist/gh-oss-stats-linux-arm64   ./cmd/gh-oss-stats/main.go
          GOOS=darwin GOARCH=arm64  go build -o dist/gh-oss-stats-darwing-arm64 ./cmd/gh-oss-stats/main.go


      - name: Verify binaries
        run: |
          ./dist/gh-oss-stats-linux-amd64 --version   || ./dist/gh-oss-stats-linux-amd64  --help  || echo "linux-amd64 binary built successfully"
          ./dist/gh-oss-stats-linux-arm64 --version   || ./dist/gh-oss-stats-linux-arm64 --help   || echo "linux-arm64 binary built successfully"
          ./dist/gh-oss-stats-darwin-arm64 --version  || ./dist/gh-oss-stats-darwin-arm64 --help  || echo "darwin-arm64 binary built successfully"
